"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const cxschema = require("@aws-cdk/cloud-assembly-schema");
const cxapi = require("../lib");
const util_1 = require("./util");
const stackBase = {
    type: cxschema.ArtifactType.AWS_CLOUDFORMATION_STACK,
    environment: 'aws://1222344/us-east-1',
    properties: {
        templateFile: 'bla.json',
    },
};
let builder;
beforeEach(() => {
    builder = new cxapi.CloudAssemblyBuilder();
});
afterEach(() => {
    util_1.rimraf(builder.outdir);
});
test('read tags from artifact properties', () => {
    // GIVEN
    builder.addArtifact('Stack', {
        ...stackBase,
        properties: {
            ...stackBase.properties,
            tags: {
                foo: 'bar',
            },
        },
    });
    // WHEN
    const assembly = builder.buildAssembly();
    // THEN
    expect(assembly.getStackByName('Stack').tags).toEqual({ foo: 'bar' });
});
test('stack tags get uppercased when written to Cloud Assembly', () => {
    // Backwards compatibility test
    // GIVEN
    builder.addArtifact('Stack', {
        ...stackBase,
        metadata: {
            '/Stack': [
                {
                    type: 'aws:cdk:stack-tags',
                    data: [{ key: 'foo', value: 'bar' }],
                },
            ],
        },
    });
    // WHEN
    const assembly = builder.buildAssembly();
    // THEN
    const manifestStructure = JSON.parse(fs.readFileSync(path.join(assembly.directory, 'manifest.json'), { encoding: 'utf-8' }));
    expect(manifestStructure.artifacts.Stack.metadata['/Stack']).toEqual([
        {
            type: 'aws:cdk:stack-tags',
            data: [
                {
                    // Note: uppercase due to historical accident
                    Key: 'foo',
                    Value: 'bar',
                },
            ],
        },
    ]);
});
test('already uppercased stack tags get left alone', () => {
    // Backwards compatibility test
    // GIVEN
    builder.addArtifact('Stack', {
        ...stackBase,
        metadata: {
            '/Stack': [
                {
                    type: 'aws:cdk:stack-tags',
                    data: [{ Key: 'foo', Value: 'bar' }],
                },
            ],
        },
    });
    // WHEN
    const assembly = builder.buildAssembly();
    // THEN
    const manifestStructure = JSON.parse(fs.readFileSync(path.join(assembly.directory, 'manifest.json'), { encoding: 'utf-8' }));
    expect(manifestStructure.artifacts.Stack.metadata['/Stack']).toEqual([
        {
            type: 'aws:cdk:stack-tags',
            data: [
                {
                    // Note: uppercase due to historical accident
                    Key: 'foo',
                    Value: 'bar',
                },
            ],
        },
    ]);
});
test('read tags from stack metadata', () => {
    // Backwards compatibility test
    // GIVEN
    builder.addArtifact('Stack', {
        ...stackBase,
        metadata: {
            '/Stack': [
                {
                    type: 'aws:cdk:stack-tags',
                    data: [{ key: 'foo', value: 'bar' }],
                },
            ],
        },
    });
    // WHEN
    const assembly = builder.buildAssembly();
    // THEN
    expect(assembly.getStackByName('Stack').tags).toEqual({ foo: 'bar' });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2stYXJ0aWZhY3QudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YWNrLWFydGlmYWN0LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLDJEQUEyRDtBQUMzRCxnQ0FBZ0M7QUFDaEMsaUNBQWdDO0FBRWhDLE1BQU0sU0FBUyxHQUFHO0lBQ2hCLElBQUksRUFBRSxRQUFRLENBQUMsWUFBWSxDQUFDLHdCQUF3QjtJQUNwRCxXQUFXLEVBQUUseUJBQXlCO0lBQ3RDLFVBQVUsRUFBRTtRQUNWLFlBQVksRUFBRSxVQUFVO0tBQ3pCO0NBQ0YsQ0FBQztBQUVGLElBQUksT0FBbUMsQ0FBQztBQUN4QyxVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsT0FBTyxHQUFHLElBQUksS0FBSyxDQUFDLG9CQUFvQixFQUFFLENBQUM7QUFDN0MsQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO0lBQ2IsYUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN6QixDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7SUFDOUMsUUFBUTtJQUNSLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFO1FBQzNCLEdBQUcsU0FBUztRQUNaLFVBQVUsRUFBRTtZQUNWLEdBQUcsU0FBUyxDQUFDLFVBQVU7WUFDdkIsSUFBSSxFQUFFO2dCQUNKLEdBQUcsRUFBRSxLQUFLO2FBQ1g7U0FDRjtLQUNGLENBQUMsQ0FBQztJQUVILE9BQU87SUFDUCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsYUFBYSxFQUFFLENBQUM7SUFFekMsT0FBTztJQUNQLE1BQU0sQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxD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LE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUV6QyxPQUFPO0lBQ1AsTUFBTSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7QUFDeEUsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgY3hzY2hlbWEgZnJvbSAnQGF3cy1jZGsvY2xvdWQtYXNzZW1ibHktc2NoZW1hJztcbmltcG9ydCAqIGFzIGN4YXBpIGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyByaW1yYWYgfSBmcm9tICcuL3V0aWwnO1xuXG5jb25zdCBzdGFja0Jhc2UgPSB7XG4gIHR5cGU6IGN4c2NoZW1hLkFydGlmYWN0VHlwZS5BV1NfQ0xPVURGT1JNQVRJT05fU1RBQ0ssXG4gIGVudmlyb25tZW50OiAnYXdzOi8vMTIyMjM0NC91cy1lYXN0LTEnLFxuICBwcm9wZXJ0aWVzOiB7XG4gICAgdGVtcGxhdGVGaWxlOiAnYmxhLmpzb24nLFxuICB9LFxufTtcblxubGV0IGJ1aWxkZXI6IGN4YXBpLkNsb3VkQXNzZW1ibHlCdWlsZGVyO1xuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGJ1aWxkZXIgPSBuZXcgY3hhcGkuQ2xvdWRBc3NlbWJseUJ1aWxkZXIoKTtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICByaW1yYWYoYnVpbGRlci5vdXRkaXIpO1xufSk7XG5cbnRlc3QoJ3JlYWQgdGFncyBmcm9tIGFydGlmYWN0IHByb3BlcnRpZXMnLCAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGJ1aWxkZXIuYWRkQXJ0aWZhY3QoJ1N0YWNrJywge1xuICAgIC4uLnN0YWNrQmFzZSxcbiAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAuLi5zdGFja0Jhc2UucHJvcGVydGllcyxcbiAgICAgIHRhZ3M6IHtcbiAgICAgICAgZm9vOiAnYmFyJyxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBhc3NlbWJseSA9IGJ1aWxkZXIuYnVpbGRBc3NlbWJseSgpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KGFzc2VtYmx5LmdldFN0YWNrQnlOYW1lKCdTdGFjaycpLnRhZ3MpLnRvRXF1YWwoeyBmb286ICdiYXInIH0pO1xufSk7XG5cbnRlc3QoJ3N0YWNrIHRhZ3MgZ2V0IHVwcGVyY2FzZWQgd2hlbiB3cml0dGVuIHRvIENsb3VkIEFzc2VtYmx5JywgKCkgPT4ge1xuICAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB0ZXN0XG4gIC8vIEdJVkVOXG4gIGJ1aWxkZXIuYWRkQXJ0aWZhY3QoJ1N0YWNrJywge1xuICAgIC4uLnN0YWNrQmFzZSxcbiAgICBtZXRhZGF0YToge1xuICAgICAgJy9TdGFjayc6IFtcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6ICdhd3M6Y2RrOnN0YWNrLXRhZ3MnLFxuICAgICAgICAgIGRhdGE6IFt7IGtleTogJ2ZvbycsIHZhbHVlOiAnYmFyJyB9XSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBhc3NlbWJseSA9IGJ1aWxkZXIuYnVpbGRBc3NlbWJseSgpO1xuXG4gIC8vIFRIRU5cbiAgY29uc3QgbWFuaWZlc3RTdHJ1Y3R1cmUgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4oYXNzZW1ibHkuZGlyZWN0b3J5LCAnbWFuaWZlc3QuanNvbicpLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pKTtcbiAgZXhwZWN0KG1hbmlmZXN0U3RydWN0dXJlLmFydGlmYWN0cy5TdGFjay5tZXRhZGF0YVsnL1N0YWNrJ10pLnRvRXF1YWwoW1xuICAgIHtcbiAgICAgIHR5cGU6ICdhd3M6Y2RrOnN0YWNrLXRhZ3MnLFxuICAgICAgZGF0YTogW1xuICAgICAgICB7XG4gICAgICAgICAgLy8gTm90ZTogdXBwZXJjYXNlIGR1ZSB0byBoaXN0b3JpY2FsIGFjY2lkZW50XG4gICAgICAgICAgS2V5OiAnZm9vJyxcbiAgICAgICAgICBWYWx1ZTogJ2JhcicsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0sXG4gIF0pO1xufSk7XG5cbnRlc3QoJ2FscmVhZHkgdXBwZXJjYXNlZCBzdGFjayB0YWdzIGdldCBsZWZ0IGFsb25lJywgKCkgPT4ge1xuICAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB0ZXN0XG4gIC8vIEdJVkVOXG4gIGJ1aWxkZXIuYWRkQXJ0aWZhY3QoJ1N0YWNrJywge1xuICAgIC4uLnN0YWNrQmFzZSxcbiAgICBtZXRhZGF0YToge1xuICAgICAgJy9TdGFjayc6IFtcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6ICdhd3M6Y2RrOnN0YWNrLXRhZ3MnLFxuICAgICAgICAgIGRhdGE6IFt7IEtleTogJ2ZvbycsIFZhbHVlOiAnYmFyJyB9IGFzIGFueV0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0sXG4gIH0pO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgYXNzZW1ibHkgPSBidWlsZGVyLmJ1aWxkQXNzZW1ibHkoKTtcblxuICAvLyBUSEVOXG4gIGNvbnN0IG1hbmlmZXN0U3RydWN0dXJlID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKGFzc2VtYmx5LmRpcmVjdG9yeSwgJ21hbmlmZXN0Lmpzb24nKSwgeyBlbmNvZGluZzogJ3V0Zi04JyB9KSk7XG4gIGV4cGVjdChtYW5pZmVzdFN0cnVjdHVyZS5hcnRpZmFjdHMuU3RhY2subWV0YWRhdGFbJy9TdGFjayddKS50b0VxdWFsKFtcbiAgICB7XG4gICAgICB0eXBlOiAnYXdzOmNkazpzdGFjay10YWdzJyxcbiAgICAgIGRhdGE6IFtcbiAgICAgICAge1xuICAgICAgICAgIC8vIE5vdGU6IHVwcGVyY2FzZSBkdWUgdG8gaGlzdG9yaWNhbCBhY2NpZGVudFxuICAgICAgICAgIEtleTogJ2ZvbycsXG4gICAgICAgICAgVmFsdWU6ICdiYXInLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9LFxuICBdKTtcbn0pO1xuXG5cbnRlc3QoJ3JlYWQgdGFncyBmcm9tIHN0YWNrIG1ldGFkYXRhJywgKCkgPT4ge1xuICAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB0ZXN0XG4gIC8vIEdJVkVOXG4gIGJ1aWxkZXIuYWRkQXJ0aWZhY3QoJ1N0YWNrJywge1xuICAgIC4uLnN0YWNrQmFzZSxcbiAgICBtZXRhZGF0YToge1xuICAgICAgJy9TdGFjayc6IFtcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6ICdhd3M6Y2RrOnN0YWNrLXRhZ3MnLFxuICAgICAgICAgIGRhdGE6IFt7IGtleTogJ2ZvbycsIHZhbHVlOiAnYmFyJyB9XSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBhc3NlbWJseSA9IGJ1aWxkZXIuYnVpbGRBc3NlbWJseSgpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KGFzc2VtYmx5LmdldFN0YWNrQnlOYW1lKCdTdGFjaycpLnRhZ3MpLnRvRXF1YWwoeyBmb286ICdiYXInIH0pO1xufSk7XG4iXX0=